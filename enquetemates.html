<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Formulaire</title>

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <!-- Leaflet Geocoder CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: #f5f7fa;
        color: #333;
        line-height: 1.6;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      header {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
        background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
        color: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      h1 {
        font-size: 1.9rem;
        margin-bottom: 10px;
      }

      .description {
        font-size: 1.1rem;
        max-width: 800px;
        margin: 0 auto;
      }

      .form-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 30px;
        margin-bottom: 30px;
      }

      .form-section {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      }

      .form-section h2 {
        color: #4b6cb7;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f0f0;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #555;
      }

      select, textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
        transition: border 0.3s;
        margin-bottom: 15px;
      }

      select:focus, textarea:focus {
        border-color: #4b6cb7;
        outline: none;
        box-shadow: 0 0 0 2px rgba(80, 107, 172, 0.2);
      }

      .header-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
      }

      .logo {
        max-width: 200px;
        height: auto;
        margin-right: 20px;
      }

      .header-text {
        flex: 1;
        text-align: center;
      }

      @media (max-width: 768px) {
        .header-content {
          flex-direction: column;
          text-align: center;
        }

        .logo {
          margin-right: 0;
          margin-top: 15px;
        }
      }

      .description {
        text-align: left;
      }

      .description p {
        text-align: left;
      }

      .description {
        text-align: left;
        line-height: 1.6;
        font-size: 1rem;
        margin: 0 auto;
        max-width: 800px;
        padding: 0 20px;
      }

      .description p {
        text-align: left;
        margin-bottom: 1.5em; /* Espace entre les paragraphes */
        line-height: 1.6;
      }
      .map-instructions {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.95);
      padding: 12px;
      border-radius: 6px;
      font-size: 0.7rem;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      max-width: 220px;
    }

    .selection-controls {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.95);
      padding: 10px;
      border-radius: 6px;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .selection-btn {
      display: block;
      width: 100%;
      padding: 8px 12px;
      margin-bottom: 5px;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .selection-btn:hover {
      background: #e9ecef;
    }

    .selection-btn.active {
      background: #4b6cb7;
      color: white;
      border-color: #4b6cb7;
    }

      .map-wrapper {
        position: relative;
        height: 500px;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
      }


      .map-div {
        width: 100%;
        height: 100%;
      }

      .legend {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.95);
        padding: 10px 15px;
        border-radius: 6px;
        font-size: 0.8rem;
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }

      .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
      }

      .legend-color {
        width: 15px;
        height: 15px;
        margin-right: 8px;
        border-radius: 3px;
      }

      .habitation-color {
        background-color: #4caf50;
      }

      .highlight-color {
        background-color: #ffeb3b;
      }

      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #4b6cb7;
        animation: spin 1s ease-in-out infinite;
        margin-right: 10px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* BARRE DE RECHERCHE */
      .leaflet-control-geocoder {
        margin-top: 8rem !important;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3) !important;
        border-radius: 6px !important;
      }
    
      .leaflet-control-geocoder input {
        width: 200px !important;
        padding: 6px 10px !important;
        font-size: 0.85rem !important;
      }

      /* FORMULAIRE DE SOUMISSION */
      .form-section {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        margin-top: 20px;
      }

      .btn {
        display: inline-block;
        background: #4b6cb7;
        color: white;
        padding: 12px 25px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: all 0.3s;
        width: 100%;
      }

      .btn:hover {
        background: #3a5795;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      .success-message,
      .error-message {
        padding: 15px;
        border-radius: 6px;
        margin-top: 15px;
        display: none;
      }

      .success-message {
        background: #d4edda;
        color: #155724;
      }

.error-message {
  color: #dc3545;
  background-color: #f8d7da;
  border: 1px solid #f5c6cb;
  padding: 12px;
  border-radius: 5px;
  margin-top: 10px;
  font-size: 14px;
  display: none;
}
/* FOOTER */
.site-footer {
  background: #f8f9fa;
  border-top: 1px solid #dee2e6;
  padding: 20px 0;
  margin-top: 2rem;
}

.footer-content {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 20px;
  max-width: 1000px;
  margin: 0 auto;
  padding: 0 20px;
}

.footer-logo .logo {
  height: 40px;
  width: auto;
  opacity: 0.7;
  transition: opacity 0.3s ease;
}

.footer-logo .logo:hover {
  opacity: 1;
}

.footer-text {
  text-align: center;
}

.footer-text p {
  margin: 2px 0;
  color: #6c757d;
  font-size: 0.9rem;
}

.footer-text p:first-child {
  font-weight: 500;
  color: #495057;
}

/* Version responsive */
@media (max-width: 768px) {
  .footer-content {
    flex-direction: column;
    gap: 15px;
    text-align: center;
  }
  
  .footer-logo .logo {
    height: 35px;
  }
  
  .footer-text p {
    font-size: 0.8rem;
  }
}

.hidden {
  display: none;
}

.location-selection {
  background: #f8f9fa;
  padding: 20px;
  border-radius: 8px;
  margin-bottom: 20px;
  border-left: 4px solid #4b6cb7;
}
    </style>
  </head>
  <body>
    <div class="container">
         <header>
        <div class="header-content">
          <div class="header-text">
            <h1>Enqu√™te sur le bien-√™tre sur le territoire compi√®gnois</h1>
          </div>
          <img src="./assets/logoUtc.png" alt="Logo" class="logo" />
        </div>
        <div class="description">
          <p>
            Bonjour, Nous sommes un groupe d'√©tudiants en G√©nie Urbain √†
            l'Universit√© de Technologie de Compi√®gne (UTC). Dans le cadre de
            notre Atelier Projet (AP), encadr√© par les Enseignants-Chercheurs M.
            Maxime Hachette, Mme Nathalie Molines et Mme Selma Baati, nous
            r√©alisons une √©tude sur le bien-√™tre et ses conditions d√©terminantes
            sur le territoire.
          </p>

          <p>
            Ce travail s'inscrit dans le projet de recherche MATES for
            Well-being (Multiscale Assessment and Territorial Equilibrium
            Simulation for Well-being), qui vise √† mieux comprendre comment les
            dimensions sociales, √©conomiques, environnementales et
            institutionnelles d'un territoire influencent le bien-√™tre des
            habitants.
          </p>

          <p>
            √Ä travers ce questionnaire, nous souhaitons recueillir votre
            ressenti sur votre cadre de vie et identifier les facteurs qui
            contribuent ou freinent le bien-√™tre au quotidien dans votre
            territoire.
          </p>

          <p>
            Votre participation est enti√®rement volontaire et anonyme. Aucune
            donn√©e permettant de vous identifier ne sera collect√©e, et vos
            r√©ponses seront analys√©es uniquement dans un cadre universitaire et
            scientifique.
          </p>

          <p>
            Le questionnaire dure environ 20 √† 25 minutes. Il n'y a ni bonne ni
            mauvaise r√©ponse : nous vous invitons simplement √† partager votre
            exp√©rience et votre ressenti personnel.
          </p>

          <p>
            ‚Ä¢ Pour le questionnaire : Axel Bodin (axel.bodin@etu.utc.fr) <br />‚Ä¢ Pour le projet MATES for Well-being : M. Maxime Hachette
            (maxime.hachette@utc.fr)
          </p>

          <p>
            √Ä la fin de l'enqu√™te, si vous le souhaitez, vous pourrez nous
            recontacter afin de recevoir une synth√®se des r√©sultats de cette
            √©tude.
          </p>

          <p>
            Votre participation est pr√©cieuse pour notre travail. Elle
            contribuera √† une meilleure compr√©hension du bien-√™tre territorial
            et √† la r√©flexion sur des territoires plus durables, √©quilibr√©s et
            inclusifs.
          </p>

          <p>Merci beaucoup pour votre temps et votre contribution.</p>
        </div>
      </header>

      <div class="form-container">
        <div class="form-section">
          <h2>Questions territoriales</h2>

          <!-- NOUVELLE SECTION : LOCALISATION -->
          <div class="location-selection">
            <div class="form-group">
              <label for="habitation-compiegne">Habitez-vous sur Compi√®gne ?</label>
              <select id="habitation-compiegne" name="habitation-compiegne" required>
                <option value="">-- S√©lectionnez une r√©ponse --</option>
                <option value="oui">Oui</option>
                <option value="non">Non</option>
              </select>
            </div>

            <!-- QUARTIERS DE COMPI√àGNE (cach√© par d√©faut) -->
            <div id="quartiers-section" class="form-group hidden">
              <label for="quartier">S√©lectionnez votre quartier :</label>
              <select id="quartier" name="quartier">
                <option value="">-- S√©lectionnez un quartier --</option>
                <option value="Bellicart">Bellicart</option>
                <option value="Camp de Royallieu">Camp de Royallieu</option>
                <option value="Centre Ville">Centre Ville</option>
                <option value="La Victoire">La Victoire</option>
                <option value="Le Clos des Roses">Le Clos des Roses</option>
                <option value="Le Petit Margny">Le Petit Margny</option>
                <option value="Les Avenues - Saint-Lazare">Les Avenues - Saint-Lazare</option>
                <option value="Les Capucins - Eglise Saint-Germain">Les Capucins - Eglise Saint-Germain</option>
                <option value="Les Jardins">Les Jardins</option>
                <option value="Les Mar√©chaux">Les Mar√©chaux</option>
                <option value="Les Sablons">Les Sablons</option>
                <option value="Les Veneurs">Les Veneurs</option>
                <option value="Royallieu Pompidou">Royallieu Pompidou</option>
                <option value="Royallieu Village">Royallieu Village</option>
              </select>
            </div>

            <!-- COMMUNES AUTOUR DE COMPI√àGNE (cach√© par d√©faut) -->
            <div id="communes-section" class="form-group hidden">
              <label for="commune">S√©lectionnez votre commune :</label>
              <select id="commune" name="commune">
                <option value="">-- S√©lectionnez une commune --</option>
                <option value="Armancourt">Armancourt</option>
                <option value="B√©thisy-Saint-Martin">B√©thisy-Saint-Martin</option>
                <option value="B√©thisy-Saint-Pierre">B√©thisy-Saint-Pierre</option>
                <option value="Bienville">Bienville</option>
                <option value="Choisy-au-Bac">Choisy-au-Bac</option>
                <option value="Clairoix">Clairoix</option>
                <option value="Janville">Janville</option>
                <option value="Jaux">Jaux</option>
                <option value="Jonqui√®res">Jonqui√®res</option>
                <option value="Lachelle">Lachelle</option>
                <option value="Lacroix-Saint-Ouen">Lacroix-Saint-Ouen</option>
                <option value="Le Meux">Le Meux</option>
                <option value="Margny-l√®s-Compi√®gne">Margny-l√®s-Compi√®gne</option>
                <option value="N√©ry">N√©ry</option>
                <option value="Saint-Jean-aux-Bois">Saint-Jean-aux-Bois</option>
                <option value="Saint-Sauveur">Saint-Sauveur</option>
                <option value="Saint-Vaast-de-Longmont">Saint-Vaast-de-Longmont</option>
                <option value="Saintines">Saintines</option>
                <option value="Venette">Venette</option>
                <option value="Verberie">Verberie</option>
                <option value="Vieux-Moulin">Vieux-Moulin</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label
              >La carte ci-dessous pr√©sente des carroyages de l'ARC (Agglom√©ration
              de la R√©gion de Compi√®gne). Veuillez s√©lectionner un carreau
              correspondant √† votre lieu d'habitation :</label
            >
          </div>

      <!-- CARTE UNIQUE : HABITATION -->
      <div class="map-wrapper">
    

        <div class="map-instructions">
          <strong>Carte : Habitation</strong>
          <ol>
            <li>Parmi les carreaux jaunes cliquez sur un carreau</li>
            <li>Re-cliquez pour d√©s√©lectionner</li>
            <li>cliquez sur la loupe pour rechercher un lieu</li>
          </ol>
        </div>

        <div class="selection-controls">
          <button
            id="btn-habitation-1"
            class="selection-btn active"
            data-type="habitation"
            data-map="1"
          >
            Lieu d'habitation
          </button>
        </div>

        <div class="legend">
          <div class="legend-item">
            <div class="legend-color habitation-color"></div>
            <span>Habitation</span>
          </div>
          <div class="legend-item">
            <div class="legend-color highlight-color"></div>
            <span>Zone s√©lectionn√©e</span>
          </div>
        </div>

        <div id="map1" class="map-div">
          <div
            id="map1-loading"
            class="loading-overlay"
            style="display: none"
          >
            <div
              class="btn"
              style="display: flex; align-items: center; width: auto"
            >
              <span class="loading"></span>
              Chargement...
            </div>
          </div>
        </div>
      </div>

      <!-- FORMULAIRE DE SOUMISSION -->
      <div class="form-section">

        <label for="commentaire">Commentaire (optionnel) :</label>
        <textarea
          id="commentaire"
          rows="4"
          placeholder="Partagez vos impressions..."
        ></textarea>

        <button id="submit-btn" class="btn">
          <span id="submit-text">Suivant</span>
          <span
            id="submit-loading"
            class="loading"
            style="display: none"
          ></span>
        </button>

        <div id="success-message" class="success-message">
          ‚úÖ Merci ! Vos r√©ponses ont √©t√© enregistr√©es avec succ√®s.
        </div>

        <div id="error-message" class="error-message">
          ‚ùå Erreur lors de l'envoi. Veuillez r√©essayer.
        </div>
      </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      // ========================================
      // CONFIGURATION
      // ========================================
      const GEOJSON_URL_MAP1 = "carro_join.geojson";

      // SUPABASE
      const SUPABASE_URL = "https://frcajhlljzdkkwzkwkse.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZyY2FqaGxsanpka2t3emt3a3NlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMTcyNTgsImV4cCI6MjA3NzY5MzI1OH0.QXDJGJwgeVxmBW-RgxBwwm10bgEygyohgT_fXlD-I2w";

      // Initialiser Supabase
      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );
      console.log("‚úÖ Supabase initialis√©");

      // Variables
      let map1;
      let gridLayer1;
      let gridData1 = new Map();
      let currentSelectionType1 = "habitation";
      let highlightedLayers = []; // Pour stocker les layers mis en surbrillance

      // ========================================
      // FONCTIONS UTILITAIRES
      // ========================================
      function getGeometryCenter(geometry) {
        if (!geometry) return null;
        if (geometry.type === "Point") {
          return geometry.coordinates;
        } else if (geometry.type === "Polygon") {
          const coords = geometry.coordinates[0];
          let sumLat = 0,
            sumLng = 0;
          for (let i = 0; i < coords.length; i++) {
            sumLng += coords[i][0];
            sumLat += coords[i][1];
          }
          return [sumLng / coords.length, sumLat / coords.length];
        }
        return null;
      }

      function formatCoordinates(coords) {
        if (!coords) return "N/A";
        return `${coords[1].toFixed(6)}, ${coords[0].toFixed(6)}`;
      }

      // Format: ID(lat, lng)
      function createCombinedText(cell) {
        if (!cell.centerCoords) return cell.id;
        const lat = cell.centerCoords[1].toFixed(6);
        const lng = cell.centerCoords[0].toFixed(6);
        return `${cell.id}(${lat}, ${lng})`;
      }

      // Fonction pour mettre en surbrillance une zone
      function highlightArea(areaName, fieldName) {
        // Retirer les surbrillances pr√©c√©dentes
        clearHighlights();
        
        const layersToHighlight = [];
        const bounds = L.latLngBounds();
        
        // Parcourir toutes les cellules pour trouver celles qui correspondent
        gridData1.forEach((cellData, gridId) => {
          const feature = cellData.layer.feature;
          if (feature && feature.properties) {
            const propertyValue = feature.properties[fieldName];
            if (propertyValue === areaName) {
              // Mettre en surbrillance
              cellData.layer.setStyle({
                fillColor: '#ffeb3b',
                fillOpacity: 0.6,
                color: '#ff9800',
                weight: 2
              });
              layersToHighlight.push(cellData.layer);
              
              // √âtendre les bounds
              const layerBounds = cellData.layer.getBounds();
              if (layerBounds.isValid()) {
                bounds.extend(layerBounds);
              }
            }
          }
        });
        
        highlightedLayers = layersToHighlight;
        
        // Zoomer sur la zone si des cellules ont √©t√© trouv√©es
        if (bounds.isValid() && !bounds.getNorthEast().equals(bounds.getSouthWest())) {
          map1.fitBounds(bounds, { padding: [20, 20], maxZoom: 16 });
        }
        
        console.log(`üîç ${layersToHighlight.length} carroyages trouv√©s pour ${areaName}`);
      }

      // Fonction pour effacer les surbrillances
      function clearHighlights() {
        highlightedLayers.forEach(layer => {
          if (!layer.cellData || !layer.cellData.habitation) {
            layer.setStyle({
              fillColor: "#a0c4ff",
              fillOpacity: 0.2,
              color: "#333",
              weight: 1
            });
          }
        });
        highlightedLayers = [];
      }

      // ========================================
      // GESTION DES FORMULAIRES DE LOCALISATION
      // ========================================
      function setupLocationForm() {
        const habitationSelect = document.getElementById('habitation-compiegne');
        const quartiersSection = document.getElementById('quartiers-section');
        const communesSection = document.getElementById('communes-section');
        const quartierSelect = document.getElementById('quartier');
        const communeSelect = document.getElementById('commune');

        habitationSelect.addEventListener('change', function() {
          const value = this.value;
          
          // Masquer toutes les sections d'abord
          quartiersSection.classList.add('hidden');
          communesSection.classList.add('hidden');
          
          // Effacer les s√©lections
          quartierSelect.value = '';
          communeSelect.value = '';
          
          // Effacer les surbrillances
          clearHighlights();
          
          if (value === 'oui') {
            quartiersSection.classList.remove('hidden');
          } else if (value === 'non') {
            communesSection.classList.remove('hidden');
          }
        });

        quartierSelect.addEventListener('change', function() {
          const quartier = this.value;
          if (quartier) {
            highlightArea(quartier, 'nom'); // Utilise le champ 'nom' pour les quartiers
          } else {
            clearHighlights();
          }
        });

        communeSelect.addEventListener('change', function() {
          const commune = this.value;
          if (commune) {
            highlightArea(commune, 'NOM_2'); // Utilise le champ 'NOM_2' pour les communes
          } else {
            clearHighlights();
          }
        });
      }

      // ========================================
      // INITIALISATION DES CARTES
      // ========================================
      let searchMarker = null; // Variable pour stocker le marqueur de recherche
      function initializeMap(mapId) {
        const map = L.map(mapId, {
          zoomControl: false,
        }).setView([49.401129, 2.79685], 13);

        L.tileLayer("https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}", {
          maxZoom: 20,
          subdomains: ["mt0", "mt1", "mt2", "mt3"],
          attribution: "&copy; Google Maps",
        }).addTo(map);

        // Ajouter la barre de recherche Nominatim
      const geocoder = L.Control.geocoder({
        defaultMarkGeocode: false,
        placeholder: "Rechercher...",
        errorMessage: "Aucun r√©sultat",
        geocoder: L.Control.Geocoder.nominatim()
      }).on("markgeocode", function (e) {
        // Supprimer l'ancien marqueur s'il existe
        if (searchMarker) {
          map.removeLayer(searchMarker);
        }

        // Zoomer sur le lieu
        map.fitBounds(e.geocode.bbox);

        // Cr√©er un nouveau marqueur
        searchMarker = L.marker(e.geocode.center)
          .addTo(map)
          .bindPopup(e.geocode.name)
          .openPopup();

        console.log("üìç Marqueur de recherche ajout√©:", e.geocode.name);
      }).addTo(map);

      // Supprimer le marqueur quand on clique en dehors
      map.on("click", function (e) {
        if (searchMarker) {
          map.removeLayer(searchMarker);
          searchMarker = null;
          console.log(" Marqueur de recherche supprim√©");
        }
      });

      return map;
    }
      // ========================================
      // CHARGEMENT GEOJSON
      // ========================================
      async function loadGeoJSONForMap(
        map,
        gridData,
        gridLayer,
        mapNumber,
        geojsonUrl
      ) {
        const loadingOverlay = document.getElementById(
          `map${mapNumber}-loading`
        );
        loadingOverlay.style.display = "flex";

        try {
          console.log(`üì• Chargement Carte ${mapNumber}: ${geojsonUrl}`);

          const response = await fetch(geojsonUrl);
          if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);

          const geojsonData = await response.json();
          console.log(
            `‚úÖ Carte ${mapNumber}: ${
              geojsonData.features?.length || 0
            } features`
          );

          processGeoJSONData(map, geojsonData, gridData, gridLayer, mapNumber);

          const bounds = L.geoJSON(geojsonData).getBounds();
          if (bounds.isValid()) {
            map.fitBounds(bounds, { padding: [20, 20] });
          }
        } catch (error) {
          console.error(`‚ùå Erreur carte ${mapNumber}:`, error);
          alert(`Erreur chargement carte ${mapNumber}: ${error.message}`);
        } finally {
          loadingOverlay.style.display = "none";
        }
      }

      // ========================================
      // TRAITEMENT GEOJSON
      // ========================================
      function processGeoJSONData(
        map,
        geojsonData,
        gridData,
        gridLayer,
        mapNumber
      ) {
        if (gridLayer) {
          map.removeLayer(gridLayer);
        }

        gridLayer = L.layerGroup().addTo(map);

        const defaultStyle = {
          color: "#333",
          weight: 1,
          fillColor: "#a0c4ff",
          fillOpacity: 0.2,
        };

        geojsonData.features.forEach((feature) => {
          const gridId =
            feature.properties?.id ||
            feature.properties?.ID ||
            `GRID_${Math.random().toString(36).substr(2, 9)}`;

          const centerCoords = getGeometryCenter(feature.geometry);

          const layer = L.geoJSON(feature, {
            style: defaultStyle,
            onEachFeature: function (feature, layer) {
              const cellData = {
                id: gridId,
                layer: layer,
                centerCoords: centerCoords,
                habitation: false,
              };

              // Stocker les donn√©es de la cellule dans le layer pour y acc√©der plus tard
              layer.cellData = cellData;

              gridData.set(gridId, cellData);

              // CLIC AVEC TOGGLE (s√©lection/d√©s√©lection)
              layer.on("click", function () {
                handleGridClickWithToggle(cellData, mapNumber);
              });

              const tooltipText = `ID: ${gridId}${
                centerCoords ? "<br>" + formatCoordinates(centerCoords) : ""
              }`;
              layer.bindTooltip(tooltipText, {
                permanent: false,
                direction: "center",
              });
            },
          }).addTo(gridLayer);
        });

        // Mettre √† jour la r√©f√©rence globale
        gridLayer1 = gridLayer;

        console.log(
          `Carte ${mapNumber}: ${geojsonData.features.length} carroyages charg√©s`
        );
      }

      // ========================================
      // GESTION DES CLICS AVEC TOGGLE
      // ========================================
      function handleGridClickWithToggle(cellData, mapNumber) {
        const currentType = currentSelectionType1;

        console.log(
          `Clic sur Carte ${mapNumber}, Type: ${currentType}, ID: ${cellData.id}`
        );

        // CARTE 1 : Habitation (une seule s√©lection)
        if (mapNumber === 1 && currentType === "habitation") {
          // Si d√©j√† s√©lectionn√©, d√©s√©lectionner
          if (cellData.habitation) {
            cellData.habitation = false;
            updateCellAppearance(cellData);
            console.log(`D√©s√©lection habitation: ${cellData.id}`);
          } else {
            // D√©s√©lectionner l'ancienne habitation
            gridData1.forEach((item) => {
              if (item.habitation) {
                item.habitation = false;
                updateCellAppearance(item);
              }
            });
            // S√©lectionner la nouvelle
            cellData.habitation = true;
            updateCellAppearance(cellData);
            console.log(`S√©lection habitation: ${cellData.id}`);
          }
        }
      }

      // ========================================
      // APPARENCE DES CARREAUX
      // ========================================
      function updateCellAppearance(cellData) {
        let fillColor = "#a0c4ff";
        let fillOpacity = 0.2;
        let color = "#333";
        let weight = 1;

        if (cellData.habitation) {
          fillColor = "#4CAF50";
          fillOpacity = 0.5;
          color = "#2E7D32";
          weight = 2;
        }

        cellData.layer.setStyle({
          fillColor: fillColor,
          fillOpacity: fillOpacity,
          color: color,
          weight: weight
        });
      }

      // ========================================
      // BOUTONS DE S√âLECTION
      // ========================================
      function setupSelectionButtons() {
        // Carte 1
        document.querySelectorAll('[data-map="1"]').forEach((button) => {
          button.addEventListener("click", function () {
            document
              .querySelectorAll('[data-map="1"]')
              .forEach((btn) => btn.classList.remove("active"));
            this.classList.add("active");
            currentSelectionType1 = this.getAttribute("data-type");
            console.log(`Carte 1: Mode ${currentSelectionType1}`);
          });
        });
      }

// ========================================
// BOUTON SUIVANT - SOUMISSION + REDIRECTION
// ========================================
document
  .getElementById("submit-btn")
  .addEventListener("click", async function () {
    const submitBtn = this;
    const submitText = document.getElementById("submit-text");
    const submitLoading = document.getElementById("submit-loading");
    const successMessage = document.getElementById("success-message");
    const errorMessage = document.getElementById("error-message");

    // Masquer les messages
    successMessage.style.display = "none";
    errorMessage.style.display = "none";

    // ========================================
    // VALIDATION DES CHAMPS OBLIGATOIRES
    // ========================================
    
    // 1. V√©rifier la question de localisation
    const habitationCompiegne = document.getElementById('habitation-compiegne').value;
    if (!habitationCompiegne) {
      showError("‚ö†Ô∏è Veuillez indiquer si vous habitez sur Compi√®gne.");
      resetButtonState();
      return;
    }

    // 2. V√©rifier la s√©lection de quartier/commune selon la r√©ponse
    if (habitationCompiegne === 'oui') {
      const quartier = document.getElementById('quartier').value;
      if (!quartier) {
        showError("‚ö†Ô∏è Veuillez s√©lectionner votre quartier.");
        resetButtonState();
        return;
      }
    } else if (habitationCompiegne === 'non') {
      const commune = document.getElementById('commune').value;
      if (!commune) {
        showError("‚ö†Ô∏è Veuillez s√©lectionner votre commune.");
        resetButtonState();
        return;
      }
    }

    // 3. V√©rifier la carte 1 (habitation)
    const habitationCells = Array.from(gridData1.values()).filter(
      (item) => item.habitation
    );
    if (habitationCells.length === 0) {
      showError("‚ö†Ô∏è Veuillez s√©lectionner votre lieu d'habitation sur la carte avant de continuer.");
      resetButtonState();
      return;
    }

    // ========================================
    // SI TOUTES LES VALIDATIONS SONT PASS√âES
    // ========================================
    
    // Loading
    submitText.textContent = "Traitement en cours...";
    submitLoading.style.display = "inline-block";
    submitBtn.disabled = true;

    try {
      // R√âCUP√âRER LES DONN√âES
      const habitationCompiegne = document.getElementById('habitation-compiegne').value;
      const quartier = document.getElementById('quartier').value;
      const commune = document.getElementById('commune').value;

      const formData = {
        commentaire: document.getElementById("commentaire").value || null,
        habitation_compiegne: habitationCompiegne,
        quartier: quartier || null,
        commune: commune || null,
        habitation:
          habitationCells.length > 0
            ? createCombinedText(habitationCells[0])
            : null,
        submitted_at: new Date().toISOString(),
      };
      

      console.log("üì§ Donn√©es √† envoyer:", formData);

      // ENVOYER √Ä SUPABASE
      const { data, error } = await supabase
        .from("enquetes3")
        .insert([formData])
        .select();

      if (error) {
        throw error;
      }

      console.log("‚úÖ Donn√©es envoy√©es:", data);
      
        document.getElementById("commentaire").value = ""; // R√©initialisation du commentaire

      // SUCC√àS - Redirection vers le lien
      submitText.textContent = "Redirection...";
      successMessage.style.display = "block";
      successMessage.textContent = "‚úÖ Page suivante";

      // Redirection apr√®s un court d√©lai
      setTimeout(() => {
        window.location.href = "https://limesurvey.utc.fr/index.php/764677?lang=fr";
      }, 2000);

    } catch (error) {
      console.error("‚ùå Erreur:", error);
      errorMessage.textContent = `‚ùå Erreur: ${error.message}`;
      errorMessage.style.display = "block";
      resetButtonState();
    }

    // ========================================
    // FONCTIONS UTILITAIRES
    // ========================================
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = "block";
      errorMessage.style.color = "#dc3545";
      errorMessage.style.backgroundColor = "#f8d7da";
      errorMessage.style.border = "1px solid #f5c6cb";
      errorMessage.style.padding = "10px";
      errorMessage.style.borderRadius = "5px";
      errorMessage.style.marginTop = "10px";
    }

    function resetButtonState() {
      submitText.textContent = "Suivant";
      submitLoading.style.display = "none";
      submitBtn.disabled = false;
    }
  });

      // ========================================
      // INITIALISATION
      // ========================================
      document.addEventListener("DOMContentLoaded", async function () {
        console.log("üöÄ Initialisation...");

        map1 = initializeMap("map1");

        await loadGeoJSONForMap(map1, gridData1, gridLayer1, 1, GEOJSON_URL_MAP1);

        setupSelectionButtons();
        setupLocationForm();

        console.log("‚úÖ Application pr√™te !");
      });
    </script>
    <!-- Footer -->
<footer class="site-footer">
  <div class="footer-content">
    <div class="footer-logo">
      <img src="./assets/logo_anr.webp" alt="Logo" class="logo">
    </div>
    <div class="footer-text">
      <p>&copy; 2025 UTC. Tous droits r√©serv√©s.</p>
      <p>Action soutenue par ANR au titre de l'Idex Super</p>
    </div>
  </div>
</footer>
  </body>
</html>