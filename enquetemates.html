<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Formulaire</title>

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <!-- Leaflet Geocoder CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: #f5f7fa;
        color: #333;
        line-height: 1.6;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
      }

      header {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
        background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
        color: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      h1 {
        font-size: 1.9rem;
        margin-bottom: 10px;
      }

      .description {
        font-size: 1.1rem;
        max-width: 800px;
        margin: 0 auto;
      }

      .form-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 30px;
        margin-bottom: 30px;
      }

      .form-section {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      }

      .form-section h2 {
        color: #4b6cb7;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f0f0;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #555;
      }

      textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
        transition: border 0.3s;
      }

      textarea:focus {
        border-color: #4b6cb7;
        outline: none;
        box-shadow: 0 0 0 2px rgba(80, 107, 172, 0.2);
      }

      .header-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
      }

      .logo {
        max-width: 200px;
        height: auto;
        margin-right: 20px;
      }

      .header-text {
        flex: 1;
        text-align: center;
      }

      @media (max-width: 768px) {
        .header-content {
          flex-direction: column;
          text-align: center;
        }

        .logo {
          margin-right: 0;
          margin-top: 15px;
        }
      }

      .description {
        text-align: left;
      }

      .description p {
        text-align: left;
      }

      .description {
        text-align: left;
        line-height: 1.6;
        font-size: 1rem;
        margin: 0 auto;
        max-width: 800px;
        padding: 0 20px;
      }

      .description p {
        text-align: left;
        margin-bottom: 1.5em; /* Espace entre les paragraphes */
        line-height: 1.6;
      }
      .map-instructions {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.95);
      padding: 12px;
      border-radius: 6px;
      font-size: 0.7rem;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      max-width: 220px;
    }

    .selection-controls {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.95);
      padding: 10px;
      border-radius: 6px;
      z-index: 1000;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    }

    .selection-btn {
      display: block;
      width: 100%;
      padding: 8px 12px;
      margin-bottom: 5px;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s;
    }

    .selection-btn:hover {
      background: #e9ecef;
    }

    .selection-btn.active {
      background: #4b6cb7;
      color: white;
      border-color: #4b6cb7;
    }
      /* CONTENEUR DES DEUX CARTES */
      .dual-map-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
        margin-bottom: 30px;
      }

      @media (max-width: 1024px) {
        .dual-map-container {
          grid-template-columns: 1fr;
        }
      }

      .map-wrapper {
        position: relative;
        height: 500px;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .map-title {
        position: absolute;
        top: 60%;
        left: 10px;
        transform: translateY(-50%);
        background: rgba(75, 108, 183, 0.95);
        color: white;
        padding: 8px 15px;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.9rem;
        z-index: 1001;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        writing-mode: vertical-rl;
        text-orientation: mixed;
      }

      .map-div {
        width: 100%;
        height: 100%;
      }



      .legend {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.95);
        padding: 10px 15px;
        border-radius: 6px;
        font-size: 0.8rem;
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }

      .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
      }

      .legend-color {
        width: 15px;
        height: 15px;
        margin-right: 8px;
        border-radius: 3px;
      }

      .habitation-color {
        background-color: #4caf50;
      }
      .bien-color {
        background-color: #2196f3;
      }
      .pas-bien-color {
        background-color: #f44336;
      }

      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #4b6cb7;
        animation: spin 1s ease-in-out infinite;
        margin-right: 10px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* BARRE DE RECHERCHE */
      .leaflet-control-geocoder {
        margin-top: 8rem !important;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3) !important;
        border-radius: 6px !important;
      }
    


      .leaflet-control-geocoder input {
        width: 200px !important;
        padding: 6px 10px !important;
        font-size: 0.85rem !important;
      }

      /* FORMULAIRE DE SOUMISSION */
      .form-section {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        margin-top: 20px;
      }

      textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
        margin-bottom: 15px;
      }

      .btn {
        display: inline-block;
        background: #4b6cb7;
        color: white;
        padding: 12px 25px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: all 0.3s;
        width: 100%;
      }

      .btn:hover {
        background: #3a5795;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      .success-message,
      .error-message {
        padding: 15px;
        border-radius: 6px;
        margin-top: 15px;
        display: none;
      }

      .success-message {
        background: #d4edda;
        color: #155724;
      }

.error-message {
  color: #dc3545;
  background-color: #f8d7da;
  border: 1px solid #f5c6cb;
  padding: 12px;
  border-radius: 5px;
  margin-top: 10px;
  font-size: 14px;
  display: none;
}
    </style>
  </head>
  <body>
    <div class="container">
         <header>
        <div class="header-content">
          <div class="header-text">
            <h1>Enqu√™te sur le bien-√™tre sur le territoire compi√®gnois</h1>
          </div>
          <img src="./assets/logoUtc.png" alt="Logo" class="logo" />
        </div>
        <div class="description">
          <p>
            Bonjour, Nous sommes un groupe d‚Äô√©tudiants en G√©nie Urbain √†
            l‚ÄôUniversit√© de Technologie de Compi√®gne (UTC). Dans le cadre de
            notre Atelier Projet (AP), encadr√© par les Enseignants-Chercheurs M.
            Maxime Hachette, Mme Nathalie Molines et Mme Selma Baati, nous
            r√©alisons une √©tude sur le bien-√™tre et ses conditions d√©terminantes
            sur le territoire.
          </p>

          <p>
            Ce travail s‚Äôinscrit dans le projet de recherche MATES for
            Well-being (Multiscale Assessment and Territorial Equilibrium
            Simulation for Well-being), qui vise √† mieux comprendre comment les
            dimensions sociales, √©conomiques, environnementales et
            institutionnelles d‚Äôun territoire influencent le bien-√™tre des
            habitants.
          </p>

          <p>
            √Ä travers ce questionnaire, nous souhaitons recueillir votre
            ressenti sur votre cadre de vie et identifier les facteurs qui
            contribuent ou freinent le bien-√™tre au quotidien dans votre
            territoire.
          </p>

          <p>
            Votre participation est enti√®rement volontaire et anonyme. Aucune
            donn√©e permettant de vous identifier ne sera collect√©e, et vos
            r√©ponses seront analys√©es uniquement dans un cadre universitaire et
            scientifique.
          </p>

          <p>
            Le questionnaire dure environ 20 √† 25 minutes. Il n‚Äôy a ni bonne ni
            mauvaise r√©ponse : nous vous invitons simplement √† partager votre
            exp√©rience et votre ressenti personnel.
          </p>

          <p>
            ‚Ä¢ Pour le questionnaire : Axel Bodin (axel.bodin@etu.utc.fr) <br />‚Ä¢
            Pour le projet MATES for Well-being : M. Maxime Hachette
            (maxime.hachette@utc.fr)
          </p>

          <p>
            √Ä la fin de l'enqu√™te, si vous le souhaitez, vous pourrez nous
            recontacter afin de recevoir une synth√®se des r√©sultats de cette
            √©tude.
          </p>

          <p>
            Votre participation est pr√©cieuse pour notre travail. Elle
            contribuera √† une meilleure compr√©hension du bien-√™tre territorial
            et √† la r√©flexion sur des territoires plus durables, √©quilibr√©s et
            inclusifs.
          </p>

          <p>Merci beaucoup pour votre temps et votre contribution.</p>
        </div>
      </header>

      <div class="form-container">
        <div class="form-section">
          <h2>Questions territoriales</h2>

          <div class="form-group">
            <label
              >Les cartes ci-dessous pr√©sentent des carroyages de l‚ÄôARC (Agglom√©ration
              de la R√©gion de Compi√®gne). Veuillez s√©lectionner pour la premi√®re carte un carreau
              correspondant √† votre lieu d‚Äôhabitation, ensuite choisissez un ou
              plusieurs carreaux correspondant √† une ou des zones dans
              lesquelles vous consid√©rez que vous vous sentez bien ou non dans la deuxi√®me carte.
              :</label
            >
          </div>
      <!-- DEUX CARTES -->
      <div class="dual-map-container">
        <!-- CARTE 1 : HABITATION -->
        <div class="map-wrapper">
          <div class="map-title">HABITATION</div>

          <div class="map-instructions">
            <strong>Carte 1 : Habitation</strong>
            <ol>
              <li>S√©lectionnez "Lieu d'habitation"</li>
              <li>Cliquez sur un carreau</li>
              <li>Re-cliquez pour d√©s√©lectionner</li>
            </ol>
          </div>

          <div class="selection-controls">
            <button
              id="btn-habitation-1"
              class="selection-btn active"
              data-type="habitation"
              data-map="1"
            >
              Lieu d'habitation
            </button>
          </div>

          <div class="legend">
            <div class="legend-item">
              <div class="legend-color habitation-color"></div>
              <span>Habitation</span>
            </div>
          </div>

          <div id="map1" class="map-div">
            <div
              id="map1-loading"
              class="loading-overlay"
              style="display: none"
            >
              <div
                class="btn"
                style="display: flex; align-items: center; width: auto"
              >
                <span class="loading"></span>
                Chargement...
              </div>
            </div>
          </div>
        </div>

        <!-- CARTE 2 : BIEN-√äTRE -->
        <div class="map-wrapper">
          <div class="map-title">BIEN-√äTRE</div>

          <div class="map-instructions">
            <strong>Carte 2 : Ressenti</strong>
            <ol>
              <li>S√©lectionnez un type</li>
              <li>Cliquez sur un ou plusieurs carreaux</li>
              <li>Re-cliquez pour d√©s√©lectionner</li>
            </ol>
          </div>

          <div class="selection-controls">
            <button
              id="btn-bien-2"
              class="selection-btn active"
              data-type="bien"
              data-map="2"
            >
              Se sent bien
            </button>
            <button
              id="btn-pas-bien-2"
              class="selection-btn"
              data-type="pas-bien"
              data-map="2"
            >
              Ne se sent pas bien
            </button>
          </div>

          <div class="legend">
            <div class="legend-item">
              <div class="legend-color bien-color"></div>
              <span>Se sent bien</span>
            </div>
            <div class="legend-item">
              <div class="legend-color pas-bien-color"></div>
              <span>Pas bien</span>
            </div>
          </div>

          <div id="map2" class="map-div">
            <div
              id="map2-loading"
              class="loading-overlay"
              style="display: none"
            >
              <div
                class="btn"
                style="display: flex; align-items: center; width: auto"
              >
                <span class="loading"></span>
                Chargement...
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- FORMULAIRE DE SOUMISSION -->
      <div class="form-section">

        <label for="commentaire">Vous pouvez d√©velopper les raisons de vos choix (optionnel) :</label>
        <textarea
          id="commentaire"
          rows="4"
          placeholder="Partagez vos impressions..."
        ></textarea>

        <button id="submit-btn" class="btn">
          <span id="submit-text">Suivant</span>
          <span
            id="submit-loading"
            class="loading"
            style="display: none"
          ></span>
        </button>

        <div id="success-message" class="success-message">
          ‚úÖ Merci ! Vos r√©ponses ont √©t√© enregistr√©es avec succ√®s.
        </div>

        <div id="error-message" class="error-message">
          ‚ùå Erreur lors de l'envoi. Veuillez r√©essayer.
        </div>
      </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      // ========================================
      // CONFIGURATION
      // ========================================
      const GEOJSON_URL_MAP1 = "CarroyageMaj.geojson";
      const GEOJSON_URL_MAP2 = "grilleARC1kmx1.geojson";

      // SUPABASE
      const SUPABASE_URL = "https://frcajhlljzdkkwzkwkse.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZyY2FqaGxsanpka2t3emt3a3NlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMTcyNTgsImV4cCI6MjA3NzY5MzI1OH0.QXDJGJwgeVxmBW-RgxBwwm10bgEygyohgT_fXlD-I2w";

      // Initialiser Supabase
      const supabase = window.supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY
      );
      console.log("‚úÖ Supabase initialis√©");

      // Variables
      let map1, map2;
      let gridLayer1, gridLayer2;
      let gridData1 = new Map();
      let gridData2 = new Map();
      let currentSelectionType1 = "habitation";
      let currentSelectionType2 = "bien";

      // ========================================
      // FONCTIONS UTILITAIRES
      // ========================================
      function getGeometryCenter(geometry) {
        if (!geometry) return null;
        if (geometry.type === "Point") {
          return geometry.coordinates;
        } else if (geometry.type === "Polygon") {
          const coords = geometry.coordinates[0];
          let sumLat = 0,
            sumLng = 0;
          for (let i = 0; i < coords.length; i++) {
            sumLng += coords[i][0];
            sumLat += coords[i][1];
          }
          return [sumLng / coords.length, sumLat / coords.length];
        }
        return null;
      }

      function formatCoordinates(coords) {
        if (!coords) return "N/A";
        return `${coords[1].toFixed(6)}, ${coords[0].toFixed(6)}`;
      }

       // Format: ID(lat, lng)
    function createCombinedText(cell) {
      if (!cell.centerCoords) return cell.id;
      const lat = cell.centerCoords[1].toFixed(6);
      const lng = cell.centerCoords[0].toFixed(6);
      return `${cell.id}(${lat}, ${lng})`;
    }

      // ========================================
      // INITIALISATION DES CARTES
      // ========================================
      let searchMarker = null; // Variable pour stocker le marqueur de recherche
      function initializeMap(mapId) {
        const map = L.map(mapId, {
          zoomControl: false,
        }).setView([49.401129, 2.79685], 13);

        L.tileLayer("https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}", {
          maxZoom: 20,
          subdomains: ["mt0", "mt1", "mt2", "mt3"],
          attribution: "&copy; Google Maps",
        }).addTo(map);

        // Ajouter la barre de recherche Nominatim
      const geocoder = L.Control.geocoder({
        defaultMarkGeocode: false,
        placeholder: "Rechercher...",
        errorMessage: "Aucun r√©sultat",
        geocoder: L.Control.Geocoder.nominatim()
      }).on("markgeocode", function (e) {
        // Supprimer l'ancien marqueur s'il existe
        if (searchMarker) {
          map.removeLayer(searchMarker);
        }

        // Zoomer sur le lieu
        map.fitBounds(e.geocode.bbox);

        // Cr√©er un nouveau marqueur
        searchMarker = L.marker(e.geocode.center)
          .addTo(map)
          .bindPopup(e.geocode.name)
          .openPopup();

        console.log("üìç Marqueur de recherche ajout√©:", e.geocode.name);
      }).addTo(map);

      // Supprimer le marqueur quand on clique en dehors
      map.on("click", function (e) {
        if (searchMarker) {
          map.removeLayer(searchMarker);
          searchMarker = null;
          console.log(" Marqueur de recherche supprim√©");
        }
      });

      return map;
    }
      // ========================================
      // CHARGEMENT GEOJSON
      // ========================================
      async function loadGeoJSONForMap(
        map,
        gridData,
        gridLayer,
        mapNumber,
        geojsonUrl
      ) {
        const loadingOverlay = document.getElementById(
          `map${mapNumber}-loading`
        );
        loadingOverlay.style.display = "flex";

        try {
          console.log(`üì• Chargement Carte ${mapNumber}: ${geojsonUrl}`);

          const response = await fetch(geojsonUrl);
          if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);

          const geojsonData = await response.json();
          console.log(
            `‚úÖ Carte ${mapNumber}: ${
              geojsonData.features?.length || 0
            } features`
          );

          processGeoJSONData(map, geojsonData, gridData, gridLayer, mapNumber);

          const bounds = L.geoJSON(geojsonData).getBounds();
          if (bounds.isValid()) {
            map.fitBounds(bounds, { padding: [20, 20] });
          }
        } catch (error) {
          console.error(`‚ùå Erreur carte ${mapNumber}:`, error);
          alert(`Erreur chargement carte ${mapNumber}: ${error.message}`);
        } finally {
          loadingOverlay.style.display = "none";
        }
      }

      // ========================================
      // TRAITEMENT GEOJSON
      // ========================================
      function processGeoJSONData(
        map,
        geojsonData,
        gridData,
        gridLayer,
        mapNumber
      ) {
        if (gridLayer) {
          map.removeLayer(gridLayer);
        }

        gridLayer = L.layerGroup().addTo(map);

        const defaultStyle = {
          color: "#333",
          weight: 1,
          fillColor: "#a0c4ff",
          fillOpacity: 0.3,
        };

        geojsonData.features.forEach((feature) => {
          const gridId =
            feature.properties?.id ||
            feature.properties?.ID ||
            `GRID_${Math.random().toString(36).substr(2, 9)}`;

          const centerCoords = getGeometryCenter(feature.geometry);

          const layer = L.geoJSON(feature, {
            style: defaultStyle,
            onEachFeature: function (feature, layer) {
              const cellData = {
                id: gridId,
                layer: layer,
                centerCoords: centerCoords,
                habitation: false,
                bien: false,
                pasBien: false,
              };

              gridData.set(gridId, cellData);

              // CLIC AVEC TOGGLE (s√©lection/d√©s√©lection)
              layer.on("click", function () {
                handleGridClickWithToggle(cellData, mapNumber);
              });

              const tooltipText = `ID: ${gridId}${
                centerCoords ? "<br>" + formatCoordinates(centerCoords) : ""
              }`;
              layer.bindTooltip(tooltipText, {
                permanent: false,
                direction: "center",
              });
            },
          }).addTo(gridLayer);
        });

        // Mettre √† jour la r√©f√©rence globale
        if (mapNumber === 1) {
          gridLayer1 = gridLayer;
        } else {
          gridLayer2 = gridLayer;
        }

        console.log(
          `Carte ${mapNumber}: ${geojsonData.features.length} carroyages charg√©s`
        );
      }

      // ========================================
      // GESTION DES CLICS AVEC TOGGLE
      // ========================================
      function handleGridClickWithToggle(cellData, mapNumber) {
        const currentType =
          mapNumber === 1 ? currentSelectionType1 : currentSelectionType2;

        console.log(
          `Clic sur Carte ${mapNumber}, Type: ${currentType}, ID: ${cellData.id}`
        );

        // CARTE 1 : Habitation (une seule s√©lection)
        if (mapNumber === 1 && currentType === "habitation") {
          // Si d√©j√† s√©lectionn√©, d√©s√©lectionner
          if (cellData.habitation) {
            cellData.habitation = false;
            updateCellAppearance(cellData);
            console.log(`D√©s√©lection habitation: ${cellData.id}`);
          } else {
            // D√©s√©lectionner l'ancienne habitation
            gridData1.forEach((item) => {
              if (item.habitation) {
                item.habitation = false;
                updateCellAppearance(item);
              }
            });
            // S√©lectionner la nouvelle
            cellData.habitation = true;
            updateCellAppearance(cellData);
            console.log(`S√©lection habitation: ${cellData.id}`);
          }
        }

        // CARTE 2 : Bien / Pas bien (s√©lections multiples)
        if (mapNumber === 2) {
          if (currentType === "bien") {
            cellData.bien = !cellData.bien; // Toggle
            console.log(
              `${cellData.bien ? "S√©lection" : "D√©s√©lection"} bien: ${
                cellData.id
              }`
            );
          } else if (currentType === "pas-bien") {
            cellData.pasBien = !cellData.pasBien; // Toggle
            console.log(
              `${cellData.pasBien ? "S√©lection" : "D√©s√©lection"} pas-bien: ${
                cellData.id
              }`
            );
          }
          updateCellAppearance(cellData);
        }
      }

      // ========================================
      // APPARENCE DES CARREAUX
      // ========================================
      function updateCellAppearance(cellData) {
        let fillColor = "#a0c4ff";
        let fillOpacity = 0.3;

        if (cellData.habitation) {
          fillColor = "#4CAF50";
          fillOpacity = 0.7;
        } else if (cellData.bien) {
          fillColor = "#2196F3";
          fillOpacity = 0.7;
        } else if (cellData.pasBien) {
          fillColor = "#F44336";
          fillOpacity = 0.7;
        }

        cellData.layer.setStyle({
          fillColor: fillColor,
          fillOpacity: fillOpacity,
        });
      }

      // ========================================
      // BOUTONS DE S√âLECTION
      // ========================================
      function setupSelectionButtons() {
        // Carte 1
        document.querySelectorAll('[data-map="1"]').forEach((button) => {
          button.addEventListener("click", function () {
            document
              .querySelectorAll('[data-map="1"]')
              .forEach((btn) => btn.classList.remove("active"));
            this.classList.add("active");
            currentSelectionType1 = this.getAttribute("data-type");
            console.log(`Carte 1: Mode ${currentSelectionType1}`);
          });
        });

        // Carte 2
        document.querySelectorAll('[data-map="2"]').forEach((button) => {
          button.addEventListener("click", function () {
            document
              .querySelectorAll('[data-map="2"]')
              .forEach((btn) => btn.classList.remove("active"));
            this.classList.add("active");
            currentSelectionType2 = this.getAttribute("data-type");
            console.log(`Carte 2: Mode ${currentSelectionType2}`);
          });
        });
      }

// ========================================
// BOUTON SUIVANT - SOUMISSION + REDIRECTION
// ========================================
document
  .getElementById("submit-btn")
  .addEventListener("click", async function () {
    const submitBtn = this;
    const submitText = document.getElementById("submit-text");
    const submitLoading = document.getElementById("submit-loading");
    const successMessage = document.getElementById("success-message");
    const errorMessage = document.getElementById("error-message");

    // Masquer les messages
    successMessage.style.display = "none";
    errorMessage.style.display = "none";

    // ========================================
    // VALIDATION DES CHAMPS OBLIGATOIRES
    // ========================================
    
    // 1. V√©rifier la carte 1 (habitation)
    const habitationCells = Array.from(gridData1.values()).filter(
      (item) => item.habitation
    );
    if (habitationCells.length === 0) {
      showError("‚ö†Ô∏è Veuillez s√©lectionner votre lieu d'habitation sur la carte 1 avant de continuer.");
      resetButtonState();
      return;
    }

    // 2. V√©rifier la carte 2 (bien ou pas bien)
    const bienCells = Array.from(gridData2.values()).filter(
      (item) => item.bien
    );
    const pasBienCells = Array.from(gridData2.values()).filter(
      (item) => item.pasBien
    );
    
    if (bienCells.length === 0 && pasBienCells.length === 0) {
      showError("‚ö†Ô∏è Veuillez s√©lectionner au moins une zone 'Bien' ou 'Pas bien' sur la carte 2 avant de continuer.");
      resetButtonState();
      return;
    }

    // ========================================
    // SI TOUTES LES VALIDATIONS SONT PASS√âES
    // ========================================
    
    // Loading
    submitText.textContent = "Traitement en cours...";
    submitLoading.style.display = "inline-block";
    submitBtn.disabled = true;

    try {
      // R√âCUP√âRER LES DONN√âES
      const formData = {
        commentaire: document.getElementById("commentaire").value || null,
        habitation:
          habitationCells.length > 0
            ? createCombinedText(habitationCells[0])
            : null,
        bien: bienCells.map((item) => createCombinedText(item)),
        pas_bien: pasBienCells.map((item) => createCombinedText(item)),
        submitted_at: new Date().toISOString(),
      };

      console.log("üì§ Donn√©es √† envoyer:", formData);

      // ENVOYER √Ä SUPABASE
      const { data, error } = await supabase
        .from("enquetes3")
        .insert([formData])
        .select();

      if (error) {
        throw error;
      }

      console.log("‚úÖ Donn√©es envoy√©es:", data);
      
        document.getElementById("commentaire").value = ""; // R√©initialisation du commentaire

      // SUCC√àS - Redirection vers le lien
      submitText.textContent = "Redirection...";
      successMessage.style.display = "block";
      successMessage.textContent = "‚úÖ Enqu√™te soumise avec succ√®s ! Redirection...";

      // Redirection apr√®s un court d√©lai
      setTimeout(() => {
        window.location.href = "https://limesurvey.utc.fr/index.php/618598?lang=fr";
      }, 2000);

    } catch (error) {
      console.error("‚ùå Erreur:", error);
      errorMessage.textContent = `‚ùå Erreur: ${error.message}`;
      errorMessage.style.display = "block";
      resetButtonState();
    }

    // ========================================
    // FONCTIONS UTILITAIRES
    // ========================================
    function showError(message) {
      errorMessage.textContent = message;
      errorMessage.style.display = "block";
      errorMessage.style.color = "#dc3545";
      errorMessage.style.backgroundColor = "#f8d7da";
      errorMessage.style.border = "1px solid #f5c6cb";
      errorMessage.style.padding = "10px";
      errorMessage.style.borderRadius = "5px";
      errorMessage.style.marginTop = "10px";
    }

    function resetButtonState() {
      submitText.textContent = "Suivant";
      submitLoading.style.display = "none";
      submitBtn.disabled = false;
    }
  });

      // ========================================
      // INITIALISATION
      // ========================================
      document.addEventListener("DOMContentLoaded", async function () {
        console.log("üöÄ Initialisation...");

        map1 = initializeMap("map1");
        map2 = initializeMap("map2");

        await Promise.all([
          loadGeoJSONForMap(map1, gridData1, gridLayer1, 1, GEOJSON_URL_MAP1),
          loadGeoJSONForMap(map2, gridData2, gridLayer2, 2, GEOJSON_URL_MAP2),
        ]);

        setupSelectionButtons();

        console.log("‚úÖ Application pr√™te !");
      });
    </script>
  </body>
</html>
