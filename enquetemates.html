<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Formulaire d'enqu√™te MATES</title>

    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background-color: #f5f7fa;
        color: #333;
        line-height: 1.6;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      header {
        text-align: center;
        margin-bottom: 30px;
        padding: 20px;
        background: linear-gradient(135deg, #4b6cb7 0%, #182848 100%);
        color: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .description {
        font-size: 1.1rem;
        max-width: 800px;
        margin: 0 auto;
      }

      .form-container {
        display: grid;
        grid-template-columns: 1fr;
        gap: 30px;
        margin-bottom: 30px;
      }

      .form-section {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      }

      .form-section h2 {
        color: #4b6cb7;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f0f0;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #555;
      }

      textarea {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
        transition: border 0.3s;
      }

      textarea:focus {
        border-color: #4b6cb7;
        outline: none;
        box-shadow: 0 0 0 2px rgba(80, 107, 172, 0.2);
      }

      .header-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 15px;
      }

      .logo {
        max-width: 200px;
        height: auto;
        margin-right: 20px;
      }

      .header-text {
        flex: 1;
        text-align: center;
      }

      @media (max-width: 768px) {
        .header-content {
          flex-direction: column;
          text-align: center;
        }

        .logo {
          margin-right: 0;
          margin-top: 15px;
        }
      }
      .map-container {
        position: relative;
        height: 500px;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      #map {
        width: 100%;
        height: 100%;
      }

      .map-instructions {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.95);
        padding: 12px;
        border-radius: 6px;
        font-size: 0.7rem;
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        max-width: min(250px, calc(100vw - 40px));
        width: auto;
      }

      @media (max-width: 768px) {
        .map-instructions {
          font-size: 0.65rem;
          padding: 10px;
          max-width: min(200px, calc(100vw - 30px));
        }

        .map-instructions ol {
          padding-left: 15px;
          margin: 5px 0;
        }

        .map-instructions li {
          margin-bottom: 4px;
          line-height: 1.3;
        }
      }

      @media (max-width: 480px) {
        .map-instructions {
          font-size: 0.6rem;
          padding: 8px;
          max-width: min(180px, calc(100vw - 20px));
        }
      }

      .current-selection {
        background: white;
        padding: 15px;
        border-radius: 10px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }

      .current-selection h3 {
        color: #4b6cb7;
        margin-bottom: 10px;
      }

      .grid-info {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .grid-item {
        background: #f0f4f8;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.9rem;
      }

      .grid-item strong {
        color: #4b6cb7;
      }

      .coordinates {
        font-size: 0.8rem;
        color: #666;
        margin-top: 4px;
        font-style: italic;
      }

      .btn {
        display: inline-block;
        background: #4b6cb7;
        color: white;
        padding: 12px 25px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: all 0.3s;
        text-align: center;
        text-decoration: none;
      }

      .btn:hover {
        background: #3a5795;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .btn-block {
        display: block;
        width: 100%;
      }

      .btn-limesurvey {
        background: #28a745;
        margin-top: 20px;
      }

      .btn-limesurvey:hover {
        background: #218838;
      }

      .success-message {
        background: #d4edda;
        color: #155724;
        padding: 15px;
        border-radius: 6px;
        margin-top: 20px;
        display: none;
        transition: opacity 0.5s ease;
      }

      .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 15px;
        border-radius: 6px;
        margin-top: 20px;
        display: none;
        transition: opacity 0.5s ease;
      }

      .legend {
        position: absolute;
        bottom: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.95);
        padding: 10px 15px;
        border-radius: 6px;
        font-size: 0.8rem;
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }

      .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 5px;
      }

      .legend-color {
        width: 15px;
        height: 15px;
        margin-right: 8px;
        border-radius: 3px;
      }

      .habitation-color {
        background-color: #4caf50;
      }

      .bien-color {
        background-color: #2196f3;
      }

      .pas-bien-color {
        background-color: #f44336;
      }

      .selection-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(255, 255, 255, 0.95);
        padding: 10px;
        border-radius: 6px;
        z-index: 1000;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }

      .selection-btn {
        display: block;
        width: 100%;
        padding: 8px 12px;
        margin-bottom: 5px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.2s;
      }

      .selection-btn:hover {
        background: #e9ecef;
      }

      .selection-btn.active {
        background: #4b6cb7;
        color: white;
        border-color: #4b6cb7;
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #fff;
        animation: spin 1s ease-in-out infinite;
        margin-right: 10px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        border-radius: 10px;
      }

      .limesurvey-section {
        text-align: center;
        margin-top: 30px;
        padding: 20px;
        background: white;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      }

      .limesurvey-section h3 {
        color: #4b6cb7;
        margin-bottom: 15px;
      }

      .limesurvey-description {
        color: #666;
        margin-bottom: 20px;
        font-size: 1rem;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="header-content">
          <div class="header-text">
            <h1>Enqu√™te projet MATES</h1>
          </div>
          <img src="./assets/logoUtc.png" alt="Logo" class="logo" />
        </div>
        <p class="description">
          Bonjour, nous sommes un groupe de recherche √©tudiant qui travaille sur
          la question du bien-√™tre sur les territoires. Nous vous proposons ici,
          un questionnaire qui a pour but d‚Äôen apprendre plus sur la mani√®re
          dont vous appr√©ciez le bien-√™tre et le territoire. Ce questionnaire
          est anonyme, les r√©ponses que vous nous apportez nous permettent
          d‚Äôavoir un premier aper√ßu g√©n√©ral pour les habitants du territoire.
        </p>
      </header>

      <div class="form-container">
        <div class="form-section">
          <h2>Questions territoriales</h2>

          <div class="form-group">
            <label>Veuillez s√©lectionner sur la carte trois zones:</label>
            <div class="current-selection">
              <h3>S√©lections actuelles</h3>
              <div class="grid-info">
                <div class="grid-item">
                  <strong>Habitation:</strong><br />
                  <span id="selected-habitation">Aucune s√©lection</span>
                  <div id="habitation-coords" class="coordinates"></div>
                </div>
                <div class="grid-item">
                  <strong>Se sent bien:</strong><br />
                  <span id="selected-bien">Aucune s√©lection</span>
                  <div id="bien-coords" class="coordinates"></div>
                </div>
                <div class="grid-item">
                  <strong>Ne se sent pas bien:</strong><br />
                  <span id="selected-pas-bien">Aucune s√©lection</span>
                  <div id="pas-bien-coords" class="coordinates"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="commentaire"
              >Commentaires suppl√©mentaires (optionnel)</label
            >
            <textarea
              id="commentaire"
              name="commentaire"
              rows="4"
              placeholder="Partagez vos impressions sur le territoire..."
            ></textarea>
          </div>

          <button id="submit-btn" class="btn btn-block">
            <span id="submit-text">Soumettre l'enqu√™te</span>
            <span
              id="submit-loading"
              class="loading"
              style="display: none"
            ></span>
          </button>

          <div id="success-message" class="success-message">
            Merci d'avoir particip√© √† notre enqu√™te ! Vos r√©ponses ont √©t√©
            enregistr√©es avec succ√®s.
          </div>

          <div id="error-message" class="error-message">
            Une erreur est survenue lors de l'envoi du formulaire. Veuillez
            r√©essayer.
          </div>
        </div>
      </div>

      <div class="map-container">
        <div class="map-instructions">
          <strong>Instructions :</strong>
          <ol>
            <li>S√©lectionnez un type de r√©ponse ci-contre</li>
            <li>Cliquez sur un carreau de la carte pour l'associer</li>
            <li>R√©p√©tez pour les trois types de r√©ponses</li>
          </ol>
        </div>

        <div class="selection-controls">
          <button
            id="btn-habitation"
            class="selection-btn active"
            data-type="habitation"
          >
            Lieu d'habitation
          </button>
          <button id="btn-bien" class="selection-btn" data-type="bien">
            Se sent bien
          </button>
          <button id="btn-pas-bien" class="selection-btn" data-type="pas-bien">
            Ne se sent pas bien
          </button>
        </div>

        <div class="legend">
          <div class="legend-item">
            <div class="legend-color habitation-color"></div>
            <span>Lieu d'habitation</span>
          </div>
          <div class="legend-item">
            <div class="legend-color bien-color"></div>
            <span>Se sent bien</span>
          </div>
          <div class="legend-item">
            <div class="legend-color pas-bien-color"></div>
            <span>Ne se sent pas bien</span>
          </div>
        </div>

        <div id="map">
          <div id="map-loading" class="loading-overlay" style="display: none">
            <div
              class="btn"
              style="background: #4b6cb7; display: flex; align-items: center"
            >
              <span class="loading"></span>
              Chargement des carroyages...
            </div>
          </div>
        </div>
      </div>

      <!-- Section Limesurvey en bas de la carte -->
      <div class="limesurvey-section">
        <h3>Questionnaire Compl√©mentaire</h3>
        <p class="limesurvey-description">
          Pour compl√©ter cette enqu√™te, nous vous invitons √† r√©pondre √† notre
          questionnaire d√©taill√© sur Limesurvey.
        </p>
        <a
          href="https://limesurvey.utc.fr/index.php/618598?lang=fr"
          class="btn btn-limesurvey"
          target="_blank"
        >
          Acc√©der au questionnaire Limesurvey
        </a>
        <p style="font-size: 0.9rem; color: #666; margin-top: 10px">
          (S'ouvre dans un nouvel onglet)
        </p>
      </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
      // Configuration de la carte
      let map;
      let gridLayer;
      let currentSelectionType = "habitation";

      // Donn√©es des carreaux
      let gridData = new Map();

      // URL de votre GeoJSON
      const GEOJSON_URL = "carroARCForet.geojson";

      // Configuration Supabase
      const SUPABASE_URL = "https://frcajhlljzdkkwzkwkse.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZyY2FqaGxsanpka2t3emt3a3NlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMTcyNTgsImV4cCI6MjA3NzY5MzI1OH0.QXDJGJwgeVxmBW-RgxBwwm10bgEygyohgT_fXlD-I2w";

      // URL de votre formulaire Limesurvey - √Ä MODIFIER AVEC VOTRE LIEN
      const LIMESURVEY_URL =
        "https://limesurvey.utc.fr/index.php/618598?lang=fr";

      // Initialiser Supabase
      let supabaseClient;
      try {
        supabaseClient = window.supabase.createClient(
          SUPABASE_URL,
          SUPABASE_ANON_KEY
        );
        console.log("‚úÖ Supabase initialis√© avec succ√®s");
      } catch (error) {
        console.error("‚ùå Erreur d'initialisation Supabase:", error);
      }

      // Fonction pour calculer le centre d'une g√©om√©trie
      function getGeometryCenter(geometry) {
        if (!geometry) return null;

        if (geometry.type === "Point") {
          return geometry.coordinates;
        } else if (geometry.type === "Polygon") {
          // Calculer le centre approximatif du polygone
          const coords = geometry.coordinates[0]; // Premier ring du polygone
          let sumLat = 0,
            sumLng = 0;
          for (let i = 0; i < coords.length; i++) {
            sumLng += coords[i][0];
            sumLat += coords[i][1];
          }
          return [sumLng / coords.length, sumLat / coords.length];
        } else if (geometry.type === "MultiPolygon") {
          // Prendre le premier polygone du multipolygone
          const coords = geometry.coordinates[0][0];
          let sumLat = 0,
            sumLng = 0;
          for (let i = 0; i < coords.length; i++) {
            sumLng += coords[i][0];
            sumLat += coords[i][1];
          }
          return [sumLng / coords.length, sumLat / coords.length];
        }
        return null;
      }

      // Fonction pour formater les coordonn√©es
      function formatCoordinates(coords) {
        if (!coords) return "Coordonn√©es non disponibles";
        return `${coords[1].toFixed(6)}, ${coords[0].toFixed(6)}`;
      }

      // Fonction pour cr√©er le texte combin√© ID + coordonn√©es
      function createCombinedText(cell) {
        if (!cell.centerCoords) return cell.id;
        return `${cell.id} (${formatCoordinates(cell.centerCoords)})`;
      }

      // Initialisation de la carte
      function initMap() {
        // Centrer sur une zone par d√©faut (sera ajust√©e apr√®s chargement des donn√©es)
        map = L.map("map").setView([48.8566, 2.3522], 13);

        // Ajouter la couche Google Maps Hybrid
        L.tileLayer("https://{s}.google.com/vt/lyrs=s,h&x={x}&y={y}&z={z}", {
          maxZoom: 20,
          subdomains: ["mt0", "mt1", "mt2", "mt3"],
          attribution:
            '&copy; <a href="https://maps.google.com">Google Maps</a>',
        }).addTo(map);
        // Charger les donn√©es GeoJSON
        loadGeoJSONData();

        // Mettre √† jour l'affichage des s√©lections
        updateSelectionDisplay();
      }

      // Charger les donn√©es GeoJSON
      async function loadGeoJSONData() {
        const loadingOverlay = document.getElementById("map-loading");
        loadingOverlay.style.display = "flex";

        try {
          const response = await fetch(GEOJSON_URL);

          if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status}`);
          }

          const geojsonData = await response.json();

          // Traiter les donn√©es GeoJSON
          processGeoJSONData(geojsonData);

          // Ajuster la vue de la carte pour afficher toutes les entit√©s
          const bounds = L.geoJSON(geojsonData).getBounds();
          if (bounds.isValid()) {
            map.fitBounds(bounds, { padding: [20, 20] });
          }
        } catch (error) {
          console.error(
            "Erreur lors du chargement des donn√©es GeoJSON:",
            error
          );
          alert(
            "Erreur lors du chargement des carroyages. Veuillez r√©essayer plus tard."
          );
        } finally {
          loadingOverlay.style.display = "none";
        }
      }

      // Traiter les donn√©es GeoJSON
      function processGeoJSONData(geojsonData) {
        // Supprimer la couche existante si elle existe
        if (gridLayer) {
          map.removeLayer(gridLayer);
        }

        // Cr√©er un groupe de calques pour la grille
        gridLayer = L.layerGroup().addTo(map);

        // Style par d√©faut pour les carroyages
        const defaultStyle = {
          color: "#333",
          weight: 1,
          fillColor: "#a0c4ff",
          fillOpacity: 0.3,
          className: "grid-cell",
        };

        // Cr√©er les couches pour chaque entit√© GeoJSON
        geojsonData.features.forEach((feature) => {
          // R√©cup√©rer l'ID du carroyage
          const gridId =
            feature.properties?.id ||
            feature.properties?.ID ||
            feature.id ||
            `GRID_${Math.random().toString(36).substr(2, 9)}`;

          // Calculer les coordonn√©es du centre
          const centerCoords = getGeometryCenter(feature.geometry);

          // Cr√©er la couche GeoJSON
          const layer = L.geoJSON(feature, {
            style: defaultStyle,
            onEachFeature: function (feature, layer) {
              // Stocker les donn√©es du carreau
              const cellData = {
                id: gridId,
                layer: layer,
                properties: feature.properties,
                geometry: feature.geometry,
                centerCoords: centerCoords,
                habitation: false,
                bien: false,
                pasBien: false,
              };

              gridData.set(gridId, cellData);

              // Ajouter l'√©v√©nement de clic
              layer.on("click", function (e) {
                handleGridClick(cellData);
              });

              // Ajouter un tooltip avec l'ID et les coordonn√©es
              const tooltipText = centerCoords
                ? `ID: ${gridId}<br>Coords: ${formatCoordinates(centerCoords)}`
                : `ID: ${gridId}`;

              layer.bindTooltip(tooltipText, {
                permanent: false,
                direction: "center",
                className: "grid-tooltip",
              });
            },
          }).addTo(gridLayer);
        });

        console.log(
          `Chargement de ${geojsonData.features.length} carroyages termin√©`
        );
      }

      // G√©rer le clic sur un carreau
      function handleGridClick(cellData) {
        // R√©initialiser les s√©lections pr√©c√©dentes si c'est une habitation
        // (une personne ne peut avoir qu'un seul lieu d'habitation)
        if (currentSelectionType === "habitation") {
          gridData.forEach((item) => {
            if (item.habitation) {
              item.habitation = false;
              updateCellAppearance(item);
            }
          });
        }

        // Mettre √† jour la s√©lection
        if (currentSelectionType === "habitation") {
          cellData.habitation = true;
        } else if (currentSelectionType === "bien") {
          cellData.bien = true;
        } else if (currentSelectionType === "pas-bien") {
          cellData.pasBien = true;
        }

        // Mettre √† jour l'apparence du carreau
        updateCellAppearance(cellData);

        // Mettre √† jour l'affichage des s√©lections
        updateSelectionDisplay();
      }

      // Mettre √† jour l'apparence d'un carreau
      function updateCellAppearance(cellData) {
        // D√©terminer la couleur en fonction des s√©lections
        let fillColor = "#a0c4ff"; // Couleur par d√©faut
        let fillOpacity = 0.3;

        if (cellData.habitation) {
          fillColor = "#4CAF50"; // Vert pour l'habitation
          fillOpacity = 0.7;
        } else if (cellData.bien) {
          fillColor = "#2196F3"; // Bleu pour "se sent bien"
          fillOpacity = 0.7;
        } else if (cellData.pasBien) {
          fillColor = "#F44336"; // Rouge pour "ne se sent pas bien"
          fillOpacity = 0.7;
        }

        // Appliquer le style
        cellData.layer.setStyle({
          fillColor: fillColor,
          fillOpacity: fillOpacity,
        });
      }

      // Mettre √† jour l'affichage des s√©lections
      function updateSelectionDisplay() {
        const habitationCells = Array.from(gridData.values()).filter(
          (item) => item.habitation
        );
        const bienCells = Array.from(gridData.values()).filter(
          (item) => item.bien
        );
        const pasBienCells = Array.from(gridData.values()).filter(
          (item) => item.pasBien
        );

        // Afficher l'habitation
        if (habitationCells.length > 0) {
          const cell = habitationCells[0];
          document.getElementById("selected-habitation").textContent = cell.id;
          document.getElementById("habitation-coords").textContent =
            cell.centerCoords
              ? formatCoordinates(cell.centerCoords)
              : "Coordonn√©es non disponibles";
        } else {
          document.getElementById("selected-habitation").textContent =
            "Aucune s√©lection";
          document.getElementById("habitation-coords").textContent = "";
        }

        // Afficher les zones "bien"
        if (bienCells.length > 0) {
          const bienIds = bienCells.map((cell) => cell.id).join(", ");
          const bienCoords = bienCells
            .map((cell) =>
              cell.centerCoords ? formatCoordinates(cell.centerCoords) : "N/A"
            )
            .join("; ");
          document.getElementById("selected-bien").textContent = bienIds;
          document.getElementById("bien-coords").textContent = bienCoords;
        } else {
          document.getElementById("selected-bien").textContent =
            "Aucune s√©lection";
          document.getElementById("bien-coords").textContent = "";
        }

        // Afficher les zones "pas bien"
        if (pasBienCells.length > 0) {
          const pasBienIds = pasBienCells.map((cell) => cell.id).join(", ");
          const pasBienCoords = pasBienCells
            .map((cell) =>
              cell.centerCoords ? formatCoordinates(cell.centerCoords) : "N/A"
            )
            .join("; ");
          document.getElementById("selected-pas-bien").textContent = pasBienIds;
          document.getElementById("pas-bien-coords").textContent =
            pasBienCoords;
        } else {
          document.getElementById("selected-pas-bien").textContent =
            "Aucune s√©lection";
          document.getElementById("pas-bien-coords").textContent = "";
        }
      }

      // G√©rer le changement de type de s√©lection
      function setupSelectionButtons() {
        const buttons = document.querySelectorAll(".selection-btn");

        buttons.forEach((button) => {
          button.addEventListener("click", function () {
            // D√©sactiver tous les boutons
            buttons.forEach((btn) => btn.classList.remove("active"));

            // Activer le bouton cliqu√©
            this.classList.add("active");

            // Mettre √† jour le type de s√©lection courant
            currentSelectionType = this.getAttribute("data-type");
          });
        });
      }

      // Fonction pour masquer le message de succ√®s
      function hideSuccessMessage() {
        const successMessage = document.getElementById("success-message");
        successMessage.style.display = "none";
      }

      // Soumission du formulaire
      document
        .getElementById("submit-btn")
        .addEventListener("click", async function () {
          const submitBtn = document.getElementById("submit-btn");
          const submitText = document.getElementById("submit-text");
          const submitLoading = document.getElementById("submit-loading");
          const successMessage = document.getElementById("success-message");
          const errorMessage = document.getElementById("error-message");

          // Masquer les messages pr√©c√©dents
          successMessage.style.display = "none";
          errorMessage.style.display = "none";

          // Afficher l'indicateur de chargement
          submitText.style.display = "none";
          submitLoading.style.display = "inline-block";
          submitBtn.disabled = true;

          // Pr√©parer les donn√©es √† envoyer (IDs et coordonn√©es combin√©s)
          const habitationCells = Array.from(gridData.values()).filter(
            (item) => item.habitation
          );
          const bienCells = Array.from(gridData.values()).filter(
            (item) => item.bien
          );
          const pasBienCells = Array.from(gridData.values()).filter(
            (item) => item.pasBien
          );

          const formData = {
            // Donn√©es anonymes uniquement
            commentaire: document.getElementById("commentaire").value,
            // Combiner ID + coordonn√©es dans la m√™me colonne
            habitation:
              habitationCells.length > 0
                ? createCombinedText(habitationCells[0])
                : null,
            bien: bienCells.map((item) => createCombinedText(item)),
            pas_bien: pasBienCells.map((item) => createCombinedText(item)),
            submitted_at: new Date().toISOString(),
          };

          console.log("üì§ Donn√©es pr√©par√©es:", formData);

          try {
            // Envoyer les donn√©es √† Supabase si configur√©
            if (supabaseClient) {
              console.log("üîÑ Envoi vers Supabase...");

              const { data, error } = await supabaseClient
                .from("enquetes3")
                .insert([formData])
                .select();

              if (error) {
                console.error("‚ùå Erreur Supabase:", error);
                throw error;
              }

              console.log("‚úÖ Donn√©es envoy√©es avec succ√®s:", data);
              successMessage.style.display = "block";

              // Masquer le message de succ√®s apr√®s 5 secondes
              setTimeout(hideSuccessMessage, 5000);

              // R√©initialiser le formulaire imm√©diatement
              resetForm();
            } else {
              console.error("‚ùå Supabase non initialis√©");
              throw new Error("Supabase non initialis√©");
            }
          } catch (error) {
            console.error("‚ùå Erreur lors de l'envoi des donn√©es:", error);
            errorMessage.textContent = `Erreur: ${error.message}`;
            errorMessage.style.display = "block";

            // Masquer le message d'erreur apr√®s 5 secondes
            setTimeout(() => {
              errorMessage.style.display = "none";
            }, 5000);
          } finally {
            // R√©activer le bouton
            submitText.style.display = "inline";
            submitLoading.style.display = "none";
            submitBtn.disabled = false;
          }
        });

      // R√©initialiser le formulaire
      function resetForm() {
        // R√©initialiser le commentaire
        document.getElementById("commentaire").value = "";

        // R√©initialiser les s√©lections sur la carte
        gridData.forEach((item) => {
          item.habitation = false;
          item.bien = false;
          item.pasBien = false;
          updateCellAppearance(item);
        });

        updateSelectionDisplay();
      }

      // Mettre √† jour tous les liens Limesurvey avec l'URL d√©finie
      function updateLimesurveyLinks() {
        const links = document.querySelectorAll(
          'a[href="https://limesurvey.utc.fr/index.php/618598?lang=fr"]'
        );
        links.forEach((link) => {
          link.href = LIMESURVEY_URL;
        });
      }

      // Initialisation
      document.addEventListener("DOMContentLoaded", function () {
        initMap();
        setupSelectionButtons();
        updateLimesurveyLinks();
      });
    </script>
  </body>
</html>
